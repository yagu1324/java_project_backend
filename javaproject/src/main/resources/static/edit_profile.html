<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>회원정보 수정 - 모의 경매 사이트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .edit-profile-container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .profile-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #dee2e6;
            margin-bottom: 15px;
        }

        .btn-upload {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <!-- 네비게이션 바 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="auction_site_main.html">
                <i class="bi bi-hammer"></i> 모의 경매
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="auction_site_main.html">홈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="auction_register_page.html">경매 등록하기</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="auction_mypage.html">내 정보</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="edit-profile-container">
            <h3 class="text-center mb-4">회원정보 수정</h3>

            <!-- 프로필 이미지 섹션 -->
            <div class="profile-section">
                <img src="/images/default_profile.png" alt="프로필 이미지" class="profile-image" id="profileImage"
                    onerror="this.src='/images/default_profile.png'">
                <div>
                    <button class="btn btn-outline-primary btn-sm btn-upload"
                        onclick="document.getElementById('profileInput').click()">
                        <i class="bi bi-camera"></i> 사진 변경
                    </button>
                    <input type="file" id="profileInput" style="display: none" accept="image/*"
                        onchange="updateProfileImage(event)">
                </div>
            </div>

            <form id="editProfileForm" onsubmit="updateProfile(event)">
                <div class="mb-3">
                    <label for="email" class="form-label">이메일</label>
                    <input type="email" class="form-control" id="email" readonly disabled>
                </div>

                <div class="mb-3">
                    <label for="username" class="form-label">사용자 이름</label>
                    <input type="text" class="form-control" id="username" readonly disabled>
                </div>

                <div class="mb-3">
                    <label for="currentPassword" class="form-label">현재 비밀번호</label>
                    <input type="password" class="form-control" id="currentPassword" placeholder="정보 수정을 위해 입력해주세요"
                        required>
                </div>

                <div class="mb-3">
                    <label for="newPassword" class="form-label">새 비밀번호 (변경 시 입력)</label>
                    <input type="password" class="form-control" id="newPassword" placeholder="8자 이상">
                    <div id="passwordStrength" class="form-text text-danger" style="display: none;">
                        비밀번호가 너무 짧습니다.
                    </div>
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">새 비밀번호 확인</label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="비밀번호 확인">
                    <div id="passwordMatch" class="form-text text-danger" style="display: none;">
                        비밀번호가 일치하지 않습니다.
                    </div>
                </div>

                <div class="mb-3">
                    <label for="phone" class="form-label">전화번호</label>
                    <input type="tel" class="form-control" id="phone" placeholder="010-0000-0000">
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">수정 완료</button>
                    <button type="button" class="btn btn-outline-secondary"
                        onclick="location.href='auction_mypage.html'">취소</button>
                </div>

                <div class="mt-4 text-center">
                    <button type="button" class="btn btn-link text-danger text-decoration-none"
                        onclick="confirmDeleteAccount()">회원 탈퇴</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api/auth';

        // 페이지 로드시 사용자 정보 가져오기
        async function loadUserProfile() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/${userId}`);
                if (!response.ok) throw new Error('사용자 정보를 불러올 수 없습니다.');

                const data = await response.json();
                if (data.success) {
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('username').value = data.username || '';
                    document.getElementById('phone').value = data.phone || '';

                    if (data.hasProfileImage) {
                        document.getElementById('profileImage').src = `${API_BASE_URL}/user/${userId}/profile-image?t=${new Date().getTime()}`;
                    }
                }
            } catch (error) {
                console.error('프로필 로딩 오류:', error);
                alert('프로필 정보를 불러오는데 실패했습니다.');
            }
        }

        // 프로필 이미지 업데이트
        async function updateProfileImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const userId = localStorage.getItem('userId');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE_URL}/user/${userId}/profile-image`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    alert('프로필 이미지가 변경되었습니다.');
                    document.getElementById('profileImage').src = `${API_BASE_URL}/user/${userId}/profile-image?t=${new Date().getTime()}`;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('이미지 업로드 오류:', error);
                alert('이미지 업로드 실패: ' + error.message);
            }
        }

        // 비밀번호 유효성 검사
        document.getElementById('newPassword').addEventListener('input', function () {
            const password = this.value;
            const strengthDiv = document.getElementById('passwordStrength');
            if (password.length > 0 && password.length < 8) {
                strengthDiv.style.display = 'block';
            } else {
                strengthDiv.style.display = 'none';
            }
        });

        document.getElementById('confirmPassword').addEventListener('input', function () {
            const confirm = this.value;
            const password = document.getElementById('newPassword').value;
            const matchDiv = document.getElementById('passwordMatch');

            if (confirm.length > 0 && password !== confirm) {
                matchDiv.style.display = 'block';
            } else {
                matchDiv.style.display = 'none';
            }
        });

        // 회원정보 수정
        async function updateProfile(event) {
            event.preventDefault();
            const userId = localStorage.getItem('userId');

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const phone = document.getElementById('phone').value;

            if (newPassword && newPassword.length < 8) {
                alert('비밀번호는 8자 이상이어야 합니다.');
                return;
            }

            if (newPassword && newPassword !== confirmPassword) {
                alert('새 비밀번호가 일치하지 않습니다.');
                return;
            }

            try {
                const userData = {
                    phone: phone
                };

                if (newPassword) {
                    userData.newPassword = newPassword;
                }

                const response = await fetch(`${API_BASE_URL}/user/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('회원정보가 성공적으로 수정되었습니다.');
                    window.location.href = 'auction_mypage.html';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('프로필 수정 오류:', error);
                alert('회원정보 수정에 실패했습니다: ' + error.message);
            }
        }

        function confirmDeleteAccount() {
            if (confirm('정말로 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                alert('회원 탈퇴 기능은 아직 구현되지 않았습니다.');
            }
        }

        document.addEventListener('DOMContentLoaded', loadUserProfile);
    </script>
</body>

</html>